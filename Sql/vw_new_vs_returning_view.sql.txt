-- 9) New vs Returning Customers
CREATE OR REPLACE VIEW vw_new_vs_returning AS
SELECT
    o.order_id,
    o.customer_id,
    o.order_date,
    DATE_FORMAT(o.order_date, '%Y-%m-01') AS month_start,
    CASE
        WHEN DATE_FORMAT(o.order_date, '%Y-%m') =
             DATE_FORMAT(fo.first_order_date, '%Y-%m')
        THEN 'New'
        ELSE 'Returning'
    END                                   AS customer_type,
    o.net_amount
FROM ecommerce_orders_raw_table o
JOIN (
    SELECT
        customer_id,
        MIN(order_date) AS first_order_date
    FROM ecommerce_orders_raw_table
    GROUP BY customer_id
) fo
  ON o.customer_id = fo.customer_id;
